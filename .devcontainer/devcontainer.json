// .devcontainer/devcontainer.json
{
  "name": "KazSearch Postgres Dev",

  // Point to your existing docker-compose file.
  "dockerComposeFile": "../docker-compose.yml",

  // The service from your docker-compose file to attach to.
  "service": "postgres",

  // The folder inside the container where your code is mounted.
  "workspaceFolder": "/app",

  // Make things run as the 'postgres' user to avoid file permission issues.
  "remoteUser": "postgres",

  // Run commands after the container is created.
  // Generate .clangd with correct Postgres include paths and compile_commands.json for clangd.
  "postCreateCommand": "bash -lc 'set -e; printf \"CompileFlags:\n  Add:\n    - -I%s\n    - -I%s\n\" \"$(pg_config --includedir-server)\" \"$(pg_config --includedir)\" > .clangd; (bear -- make -C src/log_test -B || make -C src/log_test); if [ -f requirements.txt ]; then pip3 install -r requirements.txt; fi'",

  // Forward the Postgres port so you can still connect from host tools if needed.
  "forwardPorts": [5432],

  // Customize VS Code inside the container.
  "customizations": {
    "vscode": {
      "settings": {
        // Sets the integrated terminal to bash by default
        "terminal.integrated.defaultProfile.linux": "bash",
        // Prefer clangd over the Microsoft C/C++ extension's intellisense
        "C_Cpp.intelliSenseEngine": "Disabled",
        // Ensure VS Code finds clangd from PATH inside the container
        "clangd.path": "clangd",
        // Suggested extra clangd flags; adjust if your compile_commands.json differs
        "clangd.arguments": [
          "--header-insertion=never",
          "--suggest-missing-includes",
          "--background-index",
          "--clang-tidy",
          "--compile-commands-dir=/app"
        ]
      },
      "extensions": [
        // Essential for C/C++ development
        "ms-vscode.cpptools-extension-pack",
        // clangd language server for better C/C++ experience
        "llvm-vs-code-extensions.vscode-clangd",
        // Essential for Python development
        "ms-python.python",
        "ms-python.vscode-pylint",
        // Helpful for managing the Docker environment itself
        "ms-azuretools.vscode-docker"
      ]
    }
  }
}